{% extends 'base/base_dashboard.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="deliveryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="equipment-tab" data-bs-toggle="tab" data-bs-target="#equipment" type="button" role="tab" aria-controls="equipment" aria-selected="true">
                <i class="fas fa-tools me-2"></i>Equipment Records for {{ request.user }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="accessories-tab" data-bs-toggle="tab" data-bs-target="#accessories" type="button" role="tab" aria-controls="accessories" aria-selected="false">
                <i class="fas fa-toolbox me-2"></i>Accessories Records for {{ request.user }}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="deliveryTabsContent">
        <!-- Equipment Tab -->
        <div class="tab-pane fade show active" id="equipment" role="tabpanel" aria-labelledby="equipment-tab">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Date of Receiving</th>
                            <th>Supplier</th>
                            <th>Serial Number</th>
                
                            <th>Chief Surveyor</th>
                            
                            <th>Project</th>
                            <th>Section</th>
                            <th>Date Receiving (Department)</th>
                            <th>Status</th>
                            <th>Accessories</th>
                            {% if is_admin %}
                            <th>Cancel</th>
                            {%else%}
                            <th>Receive</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for info in data %}
                        <tr>
                            <form action="{% url 'request_equipment' %}" method="post">
                                {% csrf_token %}
                                <td><a href="{% url 'equipment_detail' info.id %}">{{ info.name }}</a></td>
                                <td>{{ info.date_receiving_from_department }}</td>
                                <td>{{ info.supplier }}</td>
                                <td>{{ info.serial_number }}</td>
                   
                                <td>{{ info.chief_surveyor }}</td>
                               
                                <td>
                                    {{info.project}}
                                </td>
                                <td>
                                    {{info.section}}
                                </td>
                                <td>
                                    {{info.date_receiving_from_department}}
                                </td>
                                <td>
                                    <span class="badge {% if info.status == 'Available' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ info.status }}
                                    </span>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            onclick="openDeliveryAccessoryModal('{{ info.id }}', '{{ info.name }}', '{{ info.serial_number }}')">
                                        <i class="fas fa-toolbox"></i> View Accessories
                                    </button>
                                    <div id="delivery-accessory-count-{{ info.id }}" class="mt-1">
                                        <small class="text-muted">0 accessories</small>
                                    </div>
                                </td>
                                {% if is_admin %}
                                <td>
                                    <a href="{% url 'cancel_delivery' info.id %}" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-undo"></i> Cancel
                                    </a>
                                </td>
                                {% else %}
                                <td>
                                    <a href="{% url 'receive_delivery' info.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-check-circle"></i> Receive
                                    </a>
                                </td>
                                {% endif %}
                            </form>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Accessories Tab -->
        <div class="tab-pane fade" id="accessories" role="tabpanel" aria-labelledby="accessories-tab">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Equipment</th>
                            <th>Serial Number</th>
                            <th>Surveyor Responsible</th>
                            <th>Condition</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for accessory in accessories %}
                            
                            <tr>
                                <form action="{% url 'release_accessory' %}" method="post">
                                    {% csrf_token %}
                                    <td>{{ accessory.name }}</td>
                                    <td>{{ accessory.equipment.name }}</td>
                                    <td>{{ accessory.serial_number }}</td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" name="surveyor_responsible" value="{{ accessory.surveyor_responsible }}" required>
                                    </td>
                                    <td>
                                        <span class="badge {% if accessory.status == 'Good' %}bg-success{% elif accessory.status == 'Needs Repair' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ accessory.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {% if accessory.return_status == 'Returned' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ accessory.return_status }}
                                        </span>
                                    </td>
                                    <td>
                                        <input type="hidden" name="accessory_id" value="{{ accessory.id }}">
                                        <div class="btn-group" role="group">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-paper-plane"></i> Release
                                            </button>
                                            <a href="{% url 'return_accessory' accessory.id %}" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-undo"></i> Return to Store
                                            </a>
                                        </div>
                                    </td>
                                </form>
                            </tr>
                           
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Accessory Modal -->
<div class="modal fade" id="deliveryAccessoryModal" tabindex="-1" aria-labelledby="deliveryAccessoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="deliveryAccessoryModalLabel">
                    <i class="fas fa-truck me-2"></i>Accessories for <span id="deliveryEquipmentName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <strong>Equipment:</strong> <span id="deliveryEquipmentDetails"></span>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-info fs-6">
                            <i class="fas fa-truck me-1"></i>In Delivery
                        </span>
                    </div>
                </div>
                
                <div class="row" id="deliveryAccessoryGrid">
                    <!-- Accessories will be populated by JavaScript -->
                </div>
                
                <div class="mt-3" id="deliveryAccessorySummary">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Total Accessories:</strong> <span id="deliveryAccessoryCount">0</span> accessories coming with this equipment
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Ensure tabs are visible and properly styled */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6 !important;
        margin-bottom: 0 !important;
        background-color: #f8f9fa;
        padding: 0.5rem 0.5rem 0 0.5rem;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .nav-tabs .nav-link {
        border: 1px solid transparent !important;
        border-top-left-radius: 0.375rem !important;
        border-top-right-radius: 0.375rem !important;
        color: #6c757d !important;
        font-weight: 500 !important;
        background-color: transparent !important;
        margin-right: 0.25rem !important;
        padding: 0.75rem 1.5rem !important;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6 !important;
        color: #495057 !important;
        background-color: #e9ecef !important;
    }
    
    .nav-tabs .nav-link.active {
        color: #495057 !important;
        background-color: #fff !important;
        border-color: #dee2e6 #dee2e6 #fff !important;
        border-bottom: 2px solid #007bff !important;
        font-weight: 600 !important;
    }
    
    .tab-content {
        border: 1px solid #dee2e6 !important;
        border-top: none !important;
        border-radius: 0 0 0.375rem 0.375rem !important;
        padding: 1.5rem !important;
        background-color: #fff !important;
        min-height: 400px;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block !important;
    }
    
    .table-responsive {
        overflow-y: auto;
        max-height: calc(70vh - 8rem);
    }
    
    .table th {
        position: sticky;
        top: 0;
        background: #343a40;
        z-index: 1;
    }
    
    .table td {
        white-space: nowrap;
    }
    
    .table th {
        white-space: nowrap;
    }

    .badge {
        font-size: 0.875rem;
        padding: 0.5em 0.75em;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .form-control-sm, .form-select-sm {
        min-width: 120px;
    }

    .form-select {
        min-width: 150px;
    }

    .form-select-sm {
        font-size: 0.875rem;
        padding: 0.25rem 2rem 0.25rem 0.5rem;
    }
</style>

<!-- Accessory data for JavaScript -->
<script type="application/json" id="accessory-data">
{{ accessories_json|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing delivery tabs...');
    
    // Simple tab functionality as fallback
    function initTabs() {
        const tabButtons = document.querySelectorAll('#deliveryTabs button[data-bs-toggle="tab"]');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        console.log('Found tab buttons:', tabButtons.length);
        console.log('Found tab panes:', tabPanes.length);
        
        tabButtons.forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all buttons and panes
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => {
                    pane.classList.remove('active', 'show');
                    pane.style.display = 'none';
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Show corresponding tab pane
                const targetId = this.getAttribute('data-bs-target');
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('active', 'show');
                    targetPane.style.display = 'block';
                    console.log('Showing tab:', targetId);
                }
            });
        });
        
        // Show first tab by default
        if (tabButtons.length > 0 && tabPanes.length > 0) {
            tabButtons[0].classList.add('active');
            tabPanes[0].classList.add('active', 'show');
            tabPanes[0].style.display = 'block';
            console.log('Default tab activated');
        }
    }
    
    // Try Bootstrap first, then fallback
    if (typeof bootstrap !== 'undefined') {
        console.log('Bootstrap is loaded, using Bootstrap tabs');
        try {
            const tabList = [].slice.call(document.querySelectorAll('#deliveryTabs button[data-bs-toggle="tab"]'));
            tabList.forEach(function (tabTriggerEl) {
                const tabTrigger = new bootstrap.Tab(tabTriggerEl);
                tabTriggerEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabTrigger.show();
                });
            });
        } catch (error) {
            console.log('Bootstrap tabs failed, using fallback:', error);
            initTabs();
        }
    } else {
        console.log('Bootstrap not available, using fallback tabs');
        initTabs();
    }
    
    // Function to update accessory counts on page load
    function updateAllAccessoryCounts() {
        const accessoryDataElement = document.getElementById('accessory-data');
        if (!accessoryDataElement) {
            console.error('Accessory data element not found');
            return;
        }
        
        const accessoryData = JSON.parse(accessoryDataElement.textContent);
        console.log('Updating all accessory counts with data:', accessoryData);
        
        // Group accessories by equipment ID
        const accessoriesByEquipment = {};
        accessoryData.forEach(accessory => {
            if (accessory.equipment && accessory.equipment.id) {
                const equipmentId = accessory.equipment.id;
                if (!accessoriesByEquipment[equipmentId]) {
                    accessoriesByEquipment[equipmentId] = [];
                }
                accessoriesByEquipment[equipmentId].push(accessory);
            }
        });
        
        // Update count for each equipment
        Object.keys(accessoriesByEquipment).forEach(equipmentId => {
            const count = accessoriesByEquipment[equipmentId].length;
            const countElement = document.getElementById(`delivery-accessory-count-${equipmentId}`);
            if (countElement) {
                countElement.innerHTML = `<small class="text-info">${count} accessories</small>`;
                console.log(`Updated count for equipment ${equipmentId}: ${count} accessories`);
            }
        });
    }
    
    // Update counts when page loads
    updateAllAccessoryCounts();
    
    // Make the function globally accessible
    window.openDeliveryAccessoryModal = function(equipmentId, equipmentName, equipmentSerial) {
        console.log('Opening delivery accessory modal for:', equipmentId, equipmentName, equipmentSerial);
        
        // Update modal content
        document.getElementById('deliveryEquipmentName').textContent = equipmentName;
        document.getElementById('deliveryEquipmentDetails').textContent = `${equipmentName} (${equipmentSerial})`;
        
        // Get accessories for this equipment from the JSON data
        const accessoryDataElement = document.getElementById('accessory-data');
        if (!accessoryDataElement) {
            console.error('Accessory data element not found');
            return;
        }
        
        const accessoryData = JSON.parse(accessoryDataElement.textContent);
        console.log('All accessory data:', accessoryData);
        
        const filteredAccessories = accessoryData.filter(acc => acc.equipment && acc.equipment.id == equipmentId);
        console.log('Filtered accessories for equipment', equipmentId, ':', filteredAccessories);
        
        // Populate accessory grid
        const grid = document.getElementById('deliveryAccessoryGrid');
        grid.innerHTML = '';
        
        if (filteredAccessories.length === 0) {
            grid.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No accessories assigned to this equipment.
                    </div>
                </div>
            `;
        } else {
            filteredAccessories.forEach(accessory => {
                const accessoryCard = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card accessory-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${accessory.name}</strong><br>
                                        <small class="text-muted">SN: ${accessory.serial_number}</small><br>
                                        <span class="badge badge-sm ${accessory.condition === 'Good' ? 'bg-success' : accessory.condition === 'Needs Repair' ? 'bg-warning' : 'bg-danger'}">
                                            ${accessory.condition}
                                        </span>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge badge-sm ${accessory.return_status === 'In Use' ? 'bg-primary' : 'bg-info'}">
                                            ${accessory.return_status}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += accessoryCard;
            });
        }
        
        // Update count
        document.getElementById('deliveryAccessoryCount').textContent = filteredAccessories.length;
        
        // Update count in main table
        const countElement = document.getElementById(`delivery-accessory-count-${equipmentId}`);
        if (countElement) {
            countElement.innerHTML = `<small class="text-info">${filteredAccessories.length} accessories</small>`;
        }
        
        // Show modal
        const modalElement = document.getElementById('deliveryAccessoryModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error('Modal element not found');
        }
    };
});
</script>
{% endblock %}
